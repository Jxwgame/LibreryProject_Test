<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- ‡∏•‡∏ö jQuery, Popper ‡πÅ‡∏•‡∏∞ Bootstrap 4 JS ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bootstrap 5 -->
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="#">LIBRERY</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="order.html">‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="manage-books.html">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="login.html">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="contact.html">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="listOrder.html">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</a>
          </li>
        </ul>
      </div>
    </nav>
    <div class="container py-5">
      <h2 class="text-center mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h2>
      <button
        class="btn btn-success mb-3"
        onclick="window.location.href='addBook.html'"
      >
        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
      </button>
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th>
            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="bookTable"></tbody>
      </table>
    </div>

    <!-- Modal Edit Book -->
    <div
      class="modal fade"
      id="editBookModal"
      tabindex="-1"
      aria-labelledby="editBookModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <form id="editBookForm">
          <input type="hidden" id="editBookId" />
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editBookModalLabel">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="‡∏õ‡∏¥‡∏î"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="editBookTitle" class="form-label"
                  >‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label
                >
                <input type="text" class="form-control" id="editBookTitle" />
              </div>
              <div class="mb-3">
                <label for="editBookDescription" class="form-label"
                  >‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label
                >
                <textarea
                  class="form-control"
                  id="editBookDescription"
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="editImage" class="form-label">Upload Image</label>
                <input
                  type="file"
                  class="form-control"
                  id="editImage"
                  accept="image/*"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ‡∏õ‡∏¥‡∏î
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="updateBook()"
              >
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Bootstrap 5 JS Bundle (‡∏£‡∏ß‡∏° Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let currentEditId = null;

      function loadBooks() {
        fetch("http://localhost:3000/book")
          .then((res) => res.json())
          .then((data) => {
            const bookTable = document.getElementById("bookTable");
            bookTable.innerHTML = data
              .map(
                (book) => `
            <tr>
              <td>${book.bookId}</td>
              <td>${book.title}</td>
              <td>${book.description}</td>
              <td>
                <button 
                  class="btn btn-warning btn-sm" 
                  onclick="openEditModal(${book.bookId}, '${book.title.replace(
                  /'/g,
                  "\\'"
                )}', '${book.description.replace(/'/g, "\\'")}')"
                >
                  ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteBook(${
                  book.bookId
                })">
                  üóëÔ∏è ‡∏•‡∏ö
                </button>
              </td>
            </tr>
          `
              )
              .join("");
          })
          .catch((err) => console.error("Error loading books:", err));
      }

      function openEditModal(bookId, title, description) {
        currentEditId = bookId;
        document.getElementById("editBookId").value = bookId;
        document.getElementById("editBookTitle").value = title;
        document.getElementById("editBookDescription").value = description;
        // ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ editImage ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î error
        // document.getElementById("editImage").files[0] = image;
        new bootstrap.Modal(document.getElementById("editBookModal")).show();
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64 (Data URL)
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
        });
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡πâ‡∏ß‡∏¢ PUT request
      async function updateBook(event) {
        event.preventDefault(); // ‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á form ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
        const id = document.getElementById("bookId").value;
        const title = document.getElementById("bookTitle").value;
        const description = document.getElementById("bookDescription").value;
        const imageInput = document.getElementById("bookImage");
        const file = imageInput.files[0];

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        if (!title || !description) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
          return;
        }
        if (!file) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
          return;
        }

        try {
          // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
          const base64Image = await fileToBase64(file);

          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
          const requestData = { title, description, image: base64Image };

          // ‡∏™‡πà‡∏á PUT request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
          const response = await fetch(`http://localhost:3000/book/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
          }

          const result = await response.json();
          alert(result.message);
        } catch (error) {
          console.error("Error updating book:", error);
          alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`);
        }
      }

      function deleteBook(bookId) {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏µ‡πâ?")) {
          fetch(`http://localhost:3000/book/${bookId}`, { method: "DELETE" })
            .then((response) => {
              if (!response.ok) {
                return response.json().then((err) => {
                  throw new Error(err.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö");
                });
              }
              return response.json();
            })
            .then((result) => {
              alert(result.message || "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
              loadBooks(); // refresh ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            })
            .catch((err) => console.error("Error deleting book:", err));
        }
      }

      loadBooks();
    </script>
  </body>
</html>
