<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h2 class="text-center mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h2>
      <button class="btn btn-success mb-3" onclick="addBook()">
        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
      </button>
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th>
            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="bookTable"></tbody>
      </table>
    </div>

    <!-- Edit Book Modal -->
    <!-- Modal Edit Book -->
    <div
      class="modal fade"
      id="editBookModal"
      tabindex="-1"
      aria-labelledby="editBookModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <form id="editBookForm">
          <input type="hidden" id="editBookId" />
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editBookModalLabel">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="‡∏õ‡∏¥‡∏î"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="editBookTitle" class="form-label"
                  >‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label
                >
                <input type="text" class="form-control" id="editBookTitle" />
              </div>
              <div class="mb-3">
                <label for="editBookDescription" class="form-label"
                  >‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label
                >
                <textarea
                  class="form-control"
                  id="editBookDescription"
                ></textarea>
              </div>
              <!-- ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Å‡πá‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ -->
              <div class="mb-3">
                <label class="form-label">‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                <img
                  id="editBookImagePreview"
                  src=""
                  alt="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"
                  class="img-thumbnail"
                  style="max-height: 200px"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ‡∏õ‡∏¥‡∏î
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="updateBook()"
              >
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Bootstrap JS ‡πÅ‡∏•‡∏∞ Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let currentEditId = null;

      function loadBooks() {
        fetch("http://localhost:3000/book")
          .then((res) => res.json())
          .then((data) => {
            const bookTable = document.getElementById("bookTable");
            bookTable.innerHTML = data
              .map(
                (book) => `
            <tr>
              <td>${book.bookId}</td>
              <td>${book.title}</td>
              <td>${book.description}</td>
              <td>
                <button 
                  class="btn btn-warning btn-sm" 
                  onclick="openEditModal(${book.bookId}, '${book.title.replace(
                  /'/g,
                  "\\'"
                )}', '${book.description.replace(/'/g, "\\'")}')"
                >
                  ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteBook(${
                  book.bookId
                })">
                  üóëÔ∏è ‡∏•‡∏ö
                </button>
              </td>
            </tr>
          `
              )
              .join("");
          })
          .catch((err) => console.error("Error loading books:", err));
      }

      function openEditModal(bookId, title, description) {
        currentEditId = bookId;
        document.getElementById("editBookId").value = bookId;
        document.getElementById("editBookTitle").value = title;
        document.getElementById("editBookDescription").value = description;
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ preview ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        document.getElementById("editBookImagePreview").src = "";
        new bootstrap.Modal(document.getElementById("editBookModal")).show();
      }

      async function updateBook() {
        try {
          const id = document.getElementById("editBookId").value;
          const title = document.getElementById("editBookTitle").value;
          const description = document.getElementById(
            "editBookDescription"
          ).value;

          // Validation
          if (!title || !description) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            return;
          }

          // Prepare request data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö title ‡πÅ‡∏•‡∏∞ description ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
          const requestData = { title, description };

          // ‡∏™‡πà‡∏á PUT request ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ JSON
          const response = await fetch(`http://localhost:3000/book/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
          }

          const result = await response.json();
          alert(result.message || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

          await loadBooks();

          const modal = bootstrap.Modal.getInstance(
            document.getElementById("editBookModal")
          );
          modal.hide();

          document.getElementById("editBookForm").reset();
        } catch (error) {
          console.error("Error updating book:", error);
          alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`);
        }
      }

      function deleteBook(bookId) {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏µ‡πâ?")) {
          fetch(`http://localhost:3000/book/${bookId}`, { method: "DELETE" })
            .then(() => loadBooks())
            .catch((err) => console.error("Error deleting book:", err));
        }
      }

      loadBooks();
    </script>
  </body>
</html>
